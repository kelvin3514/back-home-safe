{"version":3,"sources":["assets/back.svg","components/Header.tsx","utils/mediaStream.ts","components/MediaStream.tsx","assets/qrOverlay.svg","components/QRCodeReader.tsx","containers/QRReader/index.tsx"],"names":["Header","name","backPath","Wrapper","to","BackButton","src","back","styled","img","div","mediaStreamErrorType","getMediaStream","cameraId","a","navigator","mediaDevices","getUserMedia","video","deviceId","facingMode","audio","console","log","Error","CAMERA_ACTIVATE_ERROR","GET_USER_MEDIA_NOT_FOUND","MediaStream","onFrame","suppressError","t","useTranslation","preferredCameraId","useCamera","useState","showUnSupportErrorModal","setShowUnSupportErrorModal","showCameraActivationErrorModal","setShowCameraActivationErrorModal","videoRef","useRef","canvasRef","useRafLoop","canvasElement","current","videoElement","readyState","HAVE_ENOUGH_DATA","canvas","getContext","height","videoHeight","width","videoWidth","drawImage","imageData","getImageData","loopStop","loopStart","initMediaStream","useCallback","undefined","stream","srcObject","play","message","useEffect","getTracks","forEach","track","stop","Video","ref","playsInline","Canvas","Dialog","open","keepMounted","aria-labelledby","aria-describedby","DialogTitle","id","DialogContent","DialogContentText","isIOS","DialogActions","Button","color","QRCodeReader","onDecode","handleFrame","code","jsQR","data","PageWrapper","QRReader","qrResult","setQrResult","browserHistory","useHistory","createTravelRecord","useTravelRecord","language","useI18n","decodedJson","qrDecode","getVenueName","trimmedZhName","trim","propOr","trimmedEnName","venueId","nameZh","nameEn","type","travelRecordType","PLACE","inputType","travelRecordInputType","SCAN","inTime","dayjs","toISOString","push","pathname","Message","VideoContainer","Overlay","isEmpty","qrOverlay"],"mappings":"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","file":"static/js/13.45c1d779.chunk.js","sourcesContent":["export default __webpack_public_path__ + \"static/media/back.7bf7a56f.svg\";","import React from \"react\";\nimport { Link } from \"react-router-dom\";\nimport styled from \"styled-components\";\nimport back from \"../assets/back.svg\";\n\ntype Props = {\n  name: string;\n  backPath?: string;\n};\n\nexport const Header = ({ name, backPath }: Props) => {\n  return (\n    <Wrapper>\n      {backPath && (\n        <Link to={backPath}>\n          <BackButton src={back} />\n        </Link>\n      )}\n      {name}\n    </Wrapper>\n  );\n};\n\nconst BackButton = styled.img`\n  height: 20px;\n  top: 14px;\n  left: 16px;\n  position: absolute;\n`;\n\nconst Wrapper = styled.div`\n  color: #ffffff;\n  background-color: #12b188;\n  text-align: center;\n  line-height: 48px;\n  text-shadow: 0px 1px 2px rgba(0, 0, 0, 0.8);\n  flex-shrink: 0;\n`;\n","export enum mediaStreamErrorType {\n  GET_USER_MEDIA_NOT_FOUND = \"GET_USER_MEDIA_NOT_FOUND\",\n  CAMERA_ACTIVATE_ERROR = \"CAMERA_ACTIVATE_ERROR\",\n}\n\nexport const getMediaStream = async (cameraId?: string) => {\n  if (\"mediaDevices\" in navigator) {\n    try {\n      // WebRTC adapter will polyfill this\n      return navigator.mediaDevices.getUserMedia({\n        video: cameraId\n          ? { deviceId: cameraId }\n          : { facingMode: \"environment\" },\n        audio: false,\n      });\n    } catch (e) {\n      console.log(e);\n      throw new Error(mediaStreamErrorType.CAMERA_ACTIVATE_ERROR);\n    }\n  } else {\n    throw new Error(mediaStreamErrorType.GET_USER_MEDIA_NOT_FOUND);\n  }\n};\n","import {\n  Button,\n  Dialog,\n  DialogActions,\n  DialogContent,\n  DialogContentText,\n  DialogTitle,\n} from \"@material-ui/core\";\nimport React, { useCallback, useEffect, useRef, useState } from \"react\";\nimport { isIOS } from \"react-device-detect\";\nimport { useTranslation } from \"react-i18next\";\nimport { Link } from \"react-router-dom\";\nimport { useRafLoop } from \"react-use\";\nimport styled from \"styled-components\";\n\nimport { useCamera } from \"../hooks/useCamera\";\nimport { getMediaStream, mediaStreamErrorType } from \"../utils/mediaStream\";\n\ntype Props = {\n  onFrame?: (imageData: ImageData) => void;\n  suppressError?: boolean;\n};\n\nexport const MediaStream = ({ onFrame, suppressError = false }: Props) => {\n  const { t } = useTranslation(\"qr_reader\");\n  const { preferredCameraId } = useCamera();\n  const [showUnSupportErrorModal, setShowUnSupportErrorModal] = useState(false);\n  const [\n    showCameraActivationErrorModal,\n    setShowCameraActivationErrorModal,\n  ] = useState(false);\n\n  const videoRef = useRef<HTMLVideoElement>(null);\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n\n  const [loopStop, loopStart] = useRafLoop(() => {\n    const canvasElement = canvasRef.current;\n    const videoElement = videoRef.current;\n\n    if (\n      canvasElement &&\n      videoElement &&\n      videoElement.readyState === videoElement.HAVE_ENOUGH_DATA\n    ) {\n      const canvas = canvasElement.getContext(\"2d\");\n      if (!canvas) return;\n\n      canvasElement.height = videoElement.videoHeight;\n      canvasElement.width = videoElement.videoWidth;\n      canvas.drawImage(\n        videoElement,\n        0,\n        0,\n        canvasElement.width,\n        canvasElement.height\n      );\n\n      const imageData = canvas.getImageData(\n        0,\n        0,\n        canvasElement.width,\n        canvasElement.height\n      );\n\n      onFrame && onFrame(imageData);\n    }\n  }, false);\n\n  const initMediaStream = useCallback(async () => {\n    const videoElement = videoRef.current;\n    if (!videoElement) return;\n\n    console.log(\"preferredCameraId\", preferredCameraId);\n\n    try {\n      const stream = await getMediaStream(\n        preferredCameraId === \"AUTO\" ? undefined : preferredCameraId\n      );\n\n      if (!stream) return;\n      videoElement.srcObject = stream;\n      videoElement.play();\n      loopStart();\n    } catch (e) {\n      switch (e.message) {\n        case mediaStreamErrorType.GET_USER_MEDIA_NOT_FOUND:\n          setShowUnSupportErrorModal(true);\n          break;\n        case mediaStreamErrorType.CAMERA_ACTIVATE_ERROR:\n          if (suppressError) return;\n          setShowCameraActivationErrorModal(true);\n          break;\n        default:\n          console.log(e);\n      }\n    }\n  }, [loopStart, preferredCameraId, suppressError]);\n\n  useEffect(() => {\n    const videoElement = videoRef.current;\n    initMediaStream();\n\n    return () => {\n      loopStop();\n      if (videoElement) {\n        const stream = videoElement.srcObject as MediaStream | null;\n        if (!stream) return;\n        const tracks = stream.getTracks();\n\n        tracks.forEach((track) => {\n          track.stop();\n        });\n\n        videoElement.srcObject = null;\n      }\n    };\n  }, [loopStart, loopStop, videoRef, initMediaStream, preferredCameraId]);\n\n  return (\n    <>\n      <Video ref={videoRef} playsInline />\n      <Canvas ref={canvasRef} />\n      <Dialog\n        open={showUnSupportErrorModal}\n        keepMounted\n        aria-labelledby=\"unsupported-device-title\"\n        aria-describedby=\"unsupported-device-description\"\n      >\n        <DialogTitle id=\"unsupported-device-title\">不支援的裝置</DialogTitle>\n        <DialogContent>\n          <DialogContentText id=\"unsupported-device-description\">\n            {t(\"message.doesnt_support_get_user_media\")}\n            {isIOS && <>{t(\"message.sure_above_ios_14\")}</>}\n          </DialogContentText>\n        </DialogContent>\n        <DialogActions>\n          <Link to=\"/\">\n            <Button color=\"primary\">{t(\"button.back_home\")}</Button>\n          </Link>\n        </DialogActions>\n      </Dialog>\n      <Dialog\n        open={showCameraActivationErrorModal}\n        keepMounted\n        aria-labelledby=\"camera-activation-title\"\n        aria-describedby=\"camera-activation-description\"\n      >\n        <DialogTitle id=\"camera-activation-title\">\n          {t(\"dialog.cannot_open_camera.title\")}\n        </DialogTitle>\n        <DialogContent>\n          <DialogContentText id=\"camera-activation-description\">\n            {t(\"dialog.cannot_open_camera.content\")}\n          </DialogContentText>\n        </DialogContent>\n        <DialogActions>\n          <Link to=\"/\">\n            <Button color=\"primary\">{t(\"button.back_home\")}</Button>\n          </Link>\n          <Link to=\"/cameraSetting\">\n            <Button color=\"primary\">{t(\"button.camera_setting\")}</Button>\n          </Link>\n        </DialogActions>\n      </Dialog>\n    </>\n  );\n};\n\nconst Video = styled.video`\n  /* Make video to at least 100% wide and tall */\n  min-width: 100%;\n  min-height: 100%;\n\n  /* Setting width & height to auto prevents the browser from stretching or squishing the video */\n  width: auto;\n  height: auto;\n\n  /* Center the video */\n  position: absolute;\n  top: 50%;\n  left: 50%;\n  transform: translate(-50%, -50%);\n`;\n\nconst Canvas = styled.canvas`\n  display: none;\n`;\n","export default __webpack_public_path__ + \"static/media/qrOverlay.185cc3ea.svg\";","import jsQR, { QRCode } from \"jsqr\";\nimport { useCallback } from \"react\";\n\nimport { MediaStream } from \"./MediaStream\";\n\ntype Props = {\n  onDecode: (code: QRCode) => void;\n};\n\nexport const QRCodeReader = ({ onDecode }: Props) => {\n  const handleFrame = useCallback(\n    (imageData: ImageData) => {\n      const code = jsQR(imageData.data, imageData.width, imageData.height);\n      code && onDecode(code);\n    },\n    [onDecode]\n  );\n\n  return <MediaStream onFrame={handleFrame} />;\n};\n","import { QRCode } from \"jsqr\";\nimport { isEmpty, propOr, trim } from \"ramda\";\nimport React, { useEffect, useState } from \"react\";\nimport { useTranslation } from \"react-i18next\";\nimport { useHistory } from \"react-router-dom\";\nimport styled from \"styled-components\";\n\nimport qrOverlay from \"../../assets/qrOverlay.svg\";\nimport { Header } from \"../../components/Header\";\nimport { QRCodeReader } from \"../../components/QRCodeReader\";\nimport { useI18n } from \"../../hooks/useI18n\";\nimport {\n  travelRecordInputType,\n  travelRecordType,\n  useTravelRecord,\n} from \"../../hooks/useTravelRecord\";\nimport { dayjs } from \"../../utils/dayjs\";\nimport { getVenueName, qrDecode } from \"../../utils/qr\";\n\nconst QRReader = () => {\n  const { t } = useTranslation(\"qr_reader\");\n  const [qrResult, setQrResult] = useState<string | null>(null);\n  const browserHistory = useHistory();\n  const { createTravelRecord } = useTravelRecord();\n  const { language } = useI18n();\n\n  const handleScan = ({ data }: QRCode) => {\n    if (!data || isEmpty(data)) return;\n    const decodedJson = qrDecode(data);\n    if (!decodedJson) return;\n\n    setQrResult(data);\n  };\n\n  useEffect(() => {\n    if (!qrResult) return;\n    const decodedJson = qrDecode(qrResult);\n    if (!decodedJson || !getVenueName(decodedJson, language)) return;\n    const trimmedZhName = trim(propOr(\"\", \"nameZh\", decodedJson));\n    const trimmedEnName = trim(propOr(\"\", \"nameEn\", decodedJson));\n\n    createTravelRecord({\n      venueId: decodedJson.venueId,\n      nameZh: trimmedZhName,\n      nameEn: trimmedEnName,\n      type: travelRecordType.PLACE,\n      inputType: travelRecordInputType.SCAN,\n      inTime: dayjs().toISOString(),\n    });\n\n    browserHistory.push({ pathname: \"/confirm\" });\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [qrResult, browserHistory]);\n\n  return (\n    <PageWrapper>\n      <Header backPath=\"/\" name={t(\"name\")} />\n      <Message>{t(\"message.scan_qr_code\")}</Message>\n      <VideoContainer>\n        <Overlay />\n        <QRCodeReader onDecode={handleScan} />\n      </VideoContainer>\n    </PageWrapper>\n  );\n};\n\nexport default QRReader;\n\nconst PageWrapper = styled.div`\n  width: 100%;\n  height: 100%;\n  text-shadow: 0px 1px 2px rgba(0, 0, 0, 0.8);\n  display: flex;\n  flex-direction: column;\n`;\n\nconst VideoContainer = styled.div`\n  width: 100%;\n  height: 100%;\n  overflow: hidden;\n  position: relative;\n`;\n\nconst Overlay = styled.div`\n  /* The image used */\n  background-image: url(\"${qrOverlay}\");\n\n  /* Full height */\n  height: 100%;\n\n  /* Center and scale the image nicely */\n  background-position: center;\n  background-repeat: no-repeat;\n  background-size: cover;\n\n  z-index: 50;\n  position: relative;\n`;\n\nconst Message = styled.div`\n  position: absolute;\n  z-index: 51;\n  bottom: 20%;\n  width: 100%;\n  text-align: center;\n  color: #ffffff;\n  font-size: 16px;\n`;\n"],"sourceRoot":""}